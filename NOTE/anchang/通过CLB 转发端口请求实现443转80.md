# 通过CLB 转发端口请求

一般我们可以通过 CLB 将指定请求转发给指定的服务器来实现负载均衡。降低单台服务器的负载，提高系统性能。 

##### 本次实验的目的

通常使用CLB来转发端口请求，可以实现类似80转443的操作。虽然可以直接在中间件中配置（也使用地址重写技术来实现）。 

#### 实验要求：

​	1.使用7层clb绑定一台服务器，配置监听器对应多域名（虚拟主机），443转80端口（多域名多证书需要开通白名单，测试号默认已开通）

​	2.访问域名1，返回“hello 1”

​	3.访问域名2，返回“hello 2”

#### 操作

##### 	准备

我们需要一台CLB一台服务器。在服务器中配置基于域名的虚拟主机 服务。 

我们这里使用httpd作为中间件。 

##### 配置web服务器

配置www根目录。这里的ruler.conf和下面的web_sitet.conf需要我们在 /etc/httpd/conf.d中创建。 

![1571735109865](https://s2.ax1x.com/2019/10/22/K8g6MT.png)

配置基于域名的虚拟主机服务。

![K8gRZ4.png](https://s2.ax1x.com/2019/10/22/K8gRZ4.png)

修改hosts文件后启动服务访问测试。 

修改hosts文件。 

![1571735605327](C:\Users\gaoy\AppData\Roaming\Typora\typora-user-images\1571735605327.png)

启动服务后测试 。

![K8gcsU.png](https://s2.ax1x.com/2019/10/22/K8gcsU.png)

##### 配置CLB

配置CLB的监听器

首先在clb中创建两个监听器， 443的https和80的监听器，在配置443端口的监听器时需要注意，这里又有一个SNI开关，开启后表示为不同域名配置不同证书，并且在这里不需要选择证书配置。直接在web服务器的配置文件中制定ssl证书就好。 

由于我没有多域名且没有对应的证书这里只能使用其他人的证书，并且不能开启SNI开关。 

这里的SNI配置文件我是不能开启的，这里只是演示。 

关于SNI （Server Name Indication）是为了解决一个服务器使用多个域名和证书的SSL/TLS扩展，简单来说就是基于域名的虚拟主机+全站HTTPS加密，而遇到了鉴别不同证书的问题，需要进行证书选择。 

原理： 在连接到服务器建立SSL链接之前先发送要访问站点的域名（Hostname），这样服务器根据这个域名返回一个合适的证书。

但是这个问题现在可以通过一个证书来解决了，不需要通过多个证书。 （不知道生产环境的使用情况）

|      |                                                          |
| ---- | :------------------------------------------------------: |
|      | ![K829Qf.jpg](https://s2.ax1x.com/2019/10/22/K829Qf.jpg) |

  关于为什么要创建两个监听器： 

​				因为一个监听器只能监听一个端口，而我们需要实现的443转发80需要两个端口实现。

创建完两个监听器，如图。 



|      | ![K82Cy8.jpg](https://s2.ax1x.com/2019/10/22/K82Cy8.jpg) |
| ---- | :------------------------------------------------------: |
|      |                                                          |

 



创建完成后需要创建规则，分别创建两个域名的对应的规则。这里不再说明。 

分别创建www.a.com 和 www.b.com的监听规则，并将对应的CVM绑定到对应的规则下面。 这个操作需要在两个监听器中都要执行。 

创建完成后我们可以将后端服务器添加到监听器中来。



|      |                                                          |
| ---- | :------------------------------------------------------: |
|      | ![K82pSP.jpg](https://s2.ax1x.com/2019/10/22/K82pSP.jpg) |

 



由于我在配置文件中并没有开启监听443端口所以这里显示异常。 

 

80监听器配置如图，和443监听器的配置相同。



|      |                                                          |
| ---- | :------------------------------------------------------: |
|      | ![K8gzWt.jpg](https://s2.ax1x.com/2019/10/22/K8gzWt.jpg) |

 

配置443转发80,也就配置重定向。

分别对两个域名配置，443转80的操作，如图。 



|      |                                                              |
| ---- | :----------------------------------------------------------: |
|      | [![K8gvFA.jpg](https://s2.ax1x.com/2019/10/22/K8gvFA.jpg)](https://imgchr.com/i/K8gvFA) |

 



访问测试，访问前请配置hosts 问clb的公网IP。 将两个域名指向同一个IP也就是CLB的外网IP。



|      |                                                              |
| :--: | :----------------------------------------------------------: |
|      | [![K8gxJI.jpg](https://s2.ax1x.com/2019/10/22/K8gxJI.jpg)](https://imgchr.com/i/K8gxJI) |

 

访问测试， 忽略证书错误， 继续访问。 

![K82POS.jpg](https://s2.ax1x.com/2019/10/22/K82POS.jpg)

看到443转80已经配置成功，如图。 

![K82Feg.jpg](https://s2.ax1x.com/2019/10/22/K82Feg.jpg)

继续访问册数 wwwb.com,如图略证书错误。 

![K82kwQ.jpg](https://s2.ax1x.com/2019/10/22/K82kwQ.jpg)

跳转后发现已经可以访问www.b.com,如图。 

![K82Aoj.jpg](https://s2.ax1x.com/2019/10/22/K82Aoj.jpg)

#### 结果验证：

通过 IE分别访问  [www.a.com](http://www.a.com)和www.b.com这两个网站clb的443端口发现可以跳转到80端口。

访问a网站，如图。 

![K82POS.jpg](https://s2.ax1x.com/2019/10/22/K82POS.jpg)

 

跳转80，如图。 

![K82Feg.jpg](https://s2.ax1x.com/2019/10/22/K82Feg.jpg)

 

访问b网站，如图。 

![K82kwQ.jpg](https://s2.ax1x.com/2019/10/22/K82kwQ.jpg)

 

跳转80，如图。



![K82Aoj.jpg](https://s2.ax1x.com/2019/10/22/K82Aoj.jpg)

通过以上的验证操作说明本次实验目443转发80的已经完成。 

补充 ： 这个正常操作是80跳转443 实现全站的https访问加密。 





​	