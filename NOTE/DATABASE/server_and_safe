
监控和服务安全
    DAY01  监控
            准备三台服务器 2.5 2.100 2.200
       监控的目的
            报告系统运行状态
       监控的资源类别
            公开数据(有服务)
                web ftp ssh 数据库等应用服务
                tcp或udp
            私有数据(无法通过端口访问的)
                cpu 内存 磁盘 网络
                用户 进程等运行信息
       监控软件
            Zabbix 简介
                高度集成的监控解决方案
                实现企业级的开源开源分布式监控
                通过c/s模式采集监控数据
                通过b/s模式实现web管理

            监控拓扑
                监控主机
                    监控服务器通过snmp或者agent采集数据
                    数据可以写入mysql oracle等数据库
                    服务器使用lnmp下实现web的前端管理
                被监控主机
                    安装agent
                    常见的网络设备支持snmp协议


            安装
                监控主机

                    安装lnmp

                        vim +65 /usr/local/nginx/conf/nginx.conf 动静分类启动fpm后
                            额外添加如下需要写在http下任意地方 不可以写到其他 地方比如location中
                            fastcgi_buffers 8 16k;                      //缓存php生成的页面内容，8个16k
                            fastcgi_buffer_size 32k;                      //缓存php生产的头部信息
                            fastcgi_connect_timeout 300;                 //连接PHP的超时时间
                            fastcgi_send_timeout 300;                     //发送请求的超时时间
                            fastcgi_read_timeout 300;                        //读取请求的超时时间
                        systemctl restart php-fpm
                        systemctl restart mariadb
                        /usr/local/nginx/sbin/nginx
                        vim /usr/local/nginx/html/info.php  //测试网页
                            <?php
                            phpinfo();
                            ?>
                    安装 zabbix
                        [root@zabbixserver lnmp_soft]# yum -y install  net-snmp-devel \
                        > curl-devel
                        //安装相关依赖包
                        [root@zabbixserver lnmp_soft]# yum -y install  \
                        > libevent-devel-2.0.21-4.el7.x86_64.rpm
                        //注意libevent-devel这个软件包在lnmp_soft目录下有提供
                        [root@zabbixserver lnmp_soft]# tar -xf zabbix-3.4.4.tar.gz
                        [root@zabbixserver lnmp_soft]# cd zabbix-3.4.4/
                        [root@zabbixserver zabbix-3.4.4]# ./configure  --enable-server \
                        > --enable-proxy --enable-agent --with-mysql=/usr/bin/mysql_config \
                        > --with-net-snmp --with-libcurl
                        // --enable-server安装部署zabbix服务器端软件
                        // --enable-agent安装部署zabbix被监控端软件
                        // --enable-proxy安装部署zabbix代理相关软件
                        // --with-mysql配置mysql_config路径
                        // --with-net-snmp允许zabbix通过snmp协议监控其他设备
                        // --with-libcurl安装相关curl库文件，这样zabbix就可以通过curl连接http等服务，测试被监控主机服务的状态
                        [root@zabbixserver zabbix-3.4.4]# make && make install



                    配置文件默认在 /usr/local/etc/
                    启动命令      /usr/local/sbin/
                    程序         /usr/local/bin/

                    初始化
                        真机
                            Firefox http://192.168.2.5/setup.php

                        2.5
                            安装必须的依赖包

                            yum -y install php-bcmath.x86_64 php-mbstring.x86_64
                            yum -y install php-gd php-xml

                            修改vim /etc/php.ini
                                date.timezone = Asia/Shanghai
                                post_max_size = 16M
                                max_execution_time = 300
                                max_input_time = 300
                            systemctl restart php-fpm.service

                            Firefox http://192.168.2.5/setup.php
                                数据库类型选择对应的
                                数据库用户 zabbix
                                数据库密码 zabbix
                                数据库服务器 localhost

                                192.168.2.5
                                登录用户 admin
                                登录用户密码 zabbix

                            修改配置文件 zabbix 启动服务
                                监控主机

                                vim /usr/local/etc/zabbix_server.conf

                                38 LogFile=/tmp/zabbix_server.log
                                85 DBHost=localhost
                                95 DBName=zabbix
                                111 DBUser=zabbix
                                119 DBPassword=zabbix

                                由于源码安装未指定用户

                                useradd zabbix
                                zabbix_server
                                ss -antulp | grep 10051

                            安装zabbix

                                被监控主机

                                      217  useradd -s /sbin/nologin zabbix
                                      218  yum -y install gcc pcre-devel

                                      220  yum -y install gcc pcre-devel
                                      221  ls
                                      222  tar -xf  zabbix-3.4.4.tar.gz
                                      223  cd zabbix-3.4.4/
                                      226  ./configure --enable-agent
                                      227  make && make install

                                      vim /usr/local/etc/zabbix_agentd.conf
                                          134 ServerActive=192.168.2.5:10051
                                          93  Server=127.0.0.1,192.168.2.5
                                          30  LogFile=/tmp/zabbix_agentd.log
                                      zabbix_agentd //启动agent服务
                                      ss -antulp |grep 10050

            自定义监控
                配置客户端

                    启动自定义监控
                        vim /usr/local/etc/zabbix_agentd.conf
                            264 Include=/usr/local/etc/zabbix_agentd.conf.d/
                             280 UnsafeUserParameters=1

                    定义监控命令
                         vim /usr/local/etc/zabbix_agentd.conf.d/user.number
                            UserParameter=user.number,wc -l /etc/passwd | awk ' {print $1} '
                    重启服务
                         killall -9 zabbix_agentd
                         zabbix_agentd
                    本机测试
                        zabbix_get -s 127.0.0.1 -p 10050 -k user.number

                配置监控服务器
                    测试客户端定义监控
                        zabbix_get -s 192.168.2.100 -p 10050 -k user.number



       Zabbix报警机制
            触发器

                触发器表达式

                    常用的表达式
                        sum(600) 600s内所有值的总和
                        sum(#)最后5个值的总和
                    {web1:system.cpu.load[all,avg1].last(0)}>5
                    web1主机最新的cpu平均负载大于5,触发器状态为问题状态
                配置邮件服务器(在监控主机本机运行邮件服务器)
                    # yum -y  install postfix
                    ]# rpm -q postfix
                    ]# systemctl  start postfix
                    ]# netstat -utnlp  | grep  :25

                    //////////确认可以使用hostname访问本机///////////////

                    ]# vim /etc/hosts
                    127.0.0.1       zabbix-server  localhost localhost.localdomain localhost4 localhost4.localdomain4
                    :wq


                    ]# yum -y  install mailx
                    [root@zabbix-server ~]# which  mailx
                    /usr/bin/mailx
                    [root@zabbix-server ~]# mail -s "xxx"  zabbix  < /etc/yum.repos.d/local.repo
                    [root@zabbix-server ~]#
                    [root@zabbix-server ~]# su - zabbix
                    [zabbix@zabbix-server ~]$
                    [zabbix@zabbix-server ~]$ mail
                    Heirloom Mail version 12.5 7/5/10.  Type ? for help.
                    "/var/spool/mail/zabbix": 1 message 1 new
                    >N  1 root                  Fri Jun 28 09:48  22/734   "xxx"
                    & exit
                    [zabbix@zabbix-server ~]$ exit
                    logout

                指定邮件服务器
                    创建Media （指定收件人）
                    创建Action   名aone
                    验证配置： 监控到主机100的用户数量大于28个时,zabbix@localhost邮箱是否收到邮件。



       Zabbix进阶操作

            自动发现
                创建自动发现

                创建动作

            主被动监控
               主动监控

               被动监控(默认)

               配置主动监控
                    配置客户端  192.168.2.201

                        安装zabbix
                            useradd zabbix
                        修改配置文件
                            vim /usr/local/etc/zabbix_agentd.conf
                            93 #Server=127.0.0.1  //
                            118 StartAgents=0   //主动链接服务器,不需要端口
                            134 ServerActive=192.168.2.5  //监控主机
                            145 Hostname=Zabbix client web2 //主动监控模式,依靠hostname区分主机
                            183 RefreshActiveChecks=120     //自动刷新时间
                        启动服务
                            zabbix_agentd
                            ps  aux | grep agentd   //只有服务没有端口
                            ss -antulp | grep 10050

                    配置监控主机
                        登录2.5管理
                        克隆模板
                          全克隆
                        修改监控项模式


            监控案例

                监控nginx

                    2.100安装lnmp
                        在客户端创建监控命令 nginx.status[*]

                    配置监控服务器

                        登陆监控服务的管理页面做如下配置:
                        1 创建监控模板 	Atmp2
                        2 创建应用集      mon-nginx
                        3 创建监控项 并关联到对应的监控命令
                        now_link_num  	  nginx.status[Active]
                        now_link_req	  nginx.status[accepts]
                        now_waiting_num   nginx.status[Waiting]

                        4 添加监控主机 并调用监控模板
                        5 查看监控数据
            总结:

            搭建zabbix监控服务器 : 部署lnmp 安装源码 zabbix 初始化配置 启动服务
            监控配置: 基本监控 自定义监控 邮件报警(报警媒介 触发器 动作)
                     自动发现 主被动监控
       DAY03


            linux基本防护
              用户账户安全
                    账户安全
                         chage  更改用户密码过期信息
                             chage –E 时间 账户名称
                             chage –l    账户名称
                             chage -l root //显示root的密码信息

                             chage -l jim  //  /etc/shadow 是保存密码相关信息的文件
                             chage -d 0 jim // -d 指定密码过期时间
                             //强制用户使用初始密码登录必须修改密码
                                最近一次密码修改时间					：密码必须更改
                                密码过期时间					：密码必须更改
                                密码失效时间					：密码必须更改


                    账户的锁定
                         passwd
                            -l 锁定账户  锁定账户后用户无法登录(对root无效)
                            -u 解锁账户
                            -S 查看状态

                    强制定期修改密码
                         /etc/login.defs  //账户密码的默认有效期
                         PASS_MAX_DAYS    99999                        //密码最长有效期
                         PASS_MIN_DAYS    0                            //密码最短有效期
                         PASS_MIN_LEN    5                            //密码最短长度
                         PASS_WARN_AGE    7                            //密码过期前几天提示警告信息
                         UID_MIN                  1000                //UID最小值
                         UID_MAX                  60000                //UID最大值

                    伪装登录提示
                         /etc/issue   //本地登录信息  默认包括系统版本 内核版本
                            为了安全,伪装登录,使之不显示 正常的系统版本和内核版本

                         /etc/issue.net  //远程登录信息
                            里面向写啥写啥 //只是伪装登录信息,登录依然可以查看正确的系统版本信息
              文件系统安全
                    程序和服务控制
                        systemctl (7)

                        checkconfig( redhat 6 5 )   服务名  on /off  开机自启/关闭开机自启


                    锁定/解锁保护文件

                        EXT3/EXT4 文件属性控制

                            命令
                                chattr 添加/删除
                                lsattr 查看
                            方法
                                + - =
                            属性 i 不可变 //可以复制

                                a 仅可追加 //可以复制

                            当你发现 作为管理员用户 无法对某个文件操作时,
                            记得查看文件的属性
                            比如  useradd dc
                                 提示 权限不够 请检查 /etc/passwd
                            入职时检查  别名的设置 看看有没有坑

            用户切换提权
                切换与提权的应用场景

                    切换用户
                        su
                        不是所有维护人员使用 root账户登录
                        su 日志文件 /var/log/secure 查看谁使用过 su

                        su 单独使用时 要求 当前管理员 密码 只将用户切换过来,环境没变
                        su -  用户和环境都变化
                         -c 使用命令

                        su - -c "command" user
                        EG:
                        su  -c "/usr/local/nginx/sbin/nginx " root

                    提权
                        sudo

                        配置文件
                            visudo
                            vim /etc/sudoers

                        提权格式
                            修改配置文件
                            用户 主机列表=命令列表
                            %名字 //用户组

                            root    ALL=(ALL)       ALL
                            用户     主机=命令
                            %wheel  ALL=(ALL)       ALL
                            wheel用户组 可以在任何地点使用任何命令以ROOT权限
                        普通用户查看提权命令
                            sudo -l
                            查看用户可以使用的提权命令




                        普通用户执行提权命令
                            vim /etc/sudoers

                                添加如下,使得可以 sudo时不需要输入密码
                                mike   localhost,dba=/sbin/* , !/sbin/ifconfig eth0 , NOPASSWD:ALL

                            启用sudo日志
                                vim /etc/sudoers
                                添加如下,之后sudo命令将会被记录
                                    Defaults logfile="/var/log/sudo"
                                cat /var/log/sudo
                                    Jun 29 14:57:35 : mike : command not allowed ; TTY=pts/1 ; PWD=/home/mike ;
                                    USER=root ; COMMAND=/sbin/ifconfig eth0
                    sudo别名设置

                        提高利用率 易读性

                            用户 User_Alias OPERATORS=jerry,tom,alice
                            主机 Host_Alias MAILSERVERS=localhost,dba
                            命令 Cmnd_Alias SOFTMGR=/usr/bin/rpm , /usr/bin/yum , /usr/bin/vim , /etc/my.cnf , /usr/bin/systemctl * mysqld

                            调用
                                OPERATORS MAILSERVERS=SOFTMGR , NOPASSWD:ALL



            ssh访问控制
                修改ssh默认访问端口
                    vim /etc/ssh/sshd_config
                        17  Port 3389     //登录端口
                        37  LoginGraceTime 2m //登录限时
                        40  MaxAuthTries 3  //最多认证次数
                        115 UseDNS no       //不解析客户机地址
                    systemctl restart sshd

                    使用新终端链接
                         ssh root@192.168.4.50 -p 3389
                ssh黑白名单

                    修改配置文件

                    vim /etc/ssh/sshd_config

                        DenyUsers user1 user2
                        AllowUsers user1@host user2@localhost
                        DenyGroups  group1 group2
                        AllowGroups group1 group2

                    eg:
                    vim /etc/ssh/sshd_config
                        AllowUsers root@192.168.4.50 alice
                        允许4.50以root登录本机,且 alice用户不受限制登录
                口令验证

                    PasswordAuthentication yes  //口令验证  默认开启
                启动密钥对登录
                    PubkeyAuthentication yes    //秘钥检查
            部署ssh公钥
                生成公钥
                    指定加密算法 -t rsa -t dsa
                ssh-keygen
                ssh-keygen -f /root/.ssh/id_rsa -N ''  -f 指定秘钥位置  -N 提供新密码 '' 表示无密码.为空

                ssh-copy-id ip
            selinux安全

                sestatus  //查看selinux 状态
                    SELinux status:                 enabled
                    SELinuxfs mount:                /sys/fs/selinux
                    SELinux root directory:         /etc/selinux
                    Loaded policy name:             targeted  //保护常用的服务; mls 全方位保护;
                    Current mode:                   enforcing
                    Mode from config file:          error (Success)
                    Policy MLS status:              enabled
                    Policy deny_unknown status:     allowed
                    Max kernel policy version:      31

                getenforce
                setenforce 1/0  //零时开启或者关闭 selinux 强制模式



            策略设置

                安全上下文
                    属性构成
                        用户:角色:访问类型:选项
                        system_u:object_r:bin_t:s0       /bin/ls

                    查看
                        文件
                            ls -lZ  文件名
                        目录
                            ls -ldZ 目录名
                        进程
                            ps aux -Z
                            ps aux -Z | grep -i 服务名
                    修改安全上下文
                        chcon
                            -t 指定访问类型
                            -R 递归修改
                    一般操作规则
                        创建的文件,一般是继承父级目录的安全上下文
                        移动的文件,原有的上下文属性不变
                        复制的文件,自动继承目标位置的上下文
