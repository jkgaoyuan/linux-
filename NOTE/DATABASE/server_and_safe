
监控和服务安全
    DAY01  监控
            准备三台服务器 2.5 2.100 2.200
       监控的目的
            报告系统运行状态
       监控的资源类别
            公开数据(有服务)
                web ftp ssh 数据库等应用服务
                tcp或udp
            私有数据(无法通过端口访问的)
                cpu 内存 磁盘 网络
                用户 进程等运行信息
       监控软件
            Zabbix 简介
                高度集成的监控解决方案
                实现企业级的开源开源分布式监控
                通过c/s模式采集监控数据
                通过b/s模式实现web管理

            监控拓扑
                监控主机
                    监控服务器通过snmp或者agent采集数据
                    数据可以写入mysql oracle等数据库
                    服务器使用lnmp下实现web的前端管理
                被监控主机
                    安装agent
                    常见的网络设备支持snmp协议


            安装
                监控主机

                    安装lnmp

                        vim +65 /usr/local/nginx/conf/nginx.conf 动静分类启动fpm后
                            额外添加如下需要写在http下任意地方 不可以写到其他 地方比如location中
                            fastcgi_buffers 8 16k;                      //缓存php生成的页面内容，8个16k
                            fastcgi_buffer_size 32k;                      //缓存php生产的头部信息
                            fastcgi_connect_timeout 300;                 //连接PHP的超时时间
                            fastcgi_send_timeout 300;                     //发送请求的超时时间
                            fastcgi_read_timeout 300;                        //读取请求的超时时间
                        systemctl restart php-fpm
                        systemctl restart mariadb
                        /usr/local/nginx/sbin/nginx
                        vim /usr/local/nginx/html/info.php  //测试网页
                            <?php
                            phpinfo();
                            ?>
                    安装 zabbix
                        [root@zabbixserver lnmp_soft]# yum -y install  net-snmp-devel \
                        > curl-devel
                        //安装相关依赖包
                        [root@zabbixserver lnmp_soft]# yum -y install  \
                        > libevent-devel-2.0.21-4.el7.x86_64.rpm
                        //注意libevent-devel这个软件包在lnmp_soft目录下有提供
                        [root@zabbixserver lnmp_soft]# tar -xf zabbix-3.4.4.tar.gz
                        [root@zabbixserver lnmp_soft]# cd zabbix-3.4.4/
                        [root@zabbixserver zabbix-3.4.4]# ./configure  --enable-server \
                        > --enable-proxy --enable-agent --with-mysql=/usr/bin/mysql_config \
                        > --with-net-snmp --with-libcurl
                        // --enable-server安装部署zabbix服务器端软件
                        // --enable-agent安装部署zabbix被监控端软件
                        // --enable-proxy安装部署zabbix代理相关软件
                        // --with-mysql配置mysql_config路径
                        // --with-net-snmp允许zabbix通过snmp协议监控其他设备
                        // --with-libcurl安装相关curl库文件，这样zabbix就可以通过curl连接http等服务，测试被监控主机服务的状态
                        [root@zabbixserver zabbix-3.4.4]# make && make install



                    配置文件默认在 /usr/local/etc/
                    启动命令      /usr/local/sbin/
                    程序         /usr/local/bin/

                    初始化
                        真机
                            Firefox http://192.168.2.5/setup.php

                        2.5
                            安装必须的依赖包

                            yum -y install php-bcmath.x86_64 php-mbstring.x86_64
                            yum -y install php-gd php-xml

                            修改vim /etc/php.ini
                                date.timezone = Asia/Shanghai
                                post_max_size = 16M
                                max_execution_time = 300
                                max_input_time = 300
                            systemctl restart php-fpm.service

                            Firefox http://192.168.2.5/setup.php
                                数据库类型选择对应的
                                数据库用户 zabbix
                                数据库密码 zabbix
                                数据库服务器 localhost

                                192.168.2.5
                                登录用户 admin
                                登录用户密码 zabbix

                            修改配置文件 zabbix 启动服务
                                监控主机

                                vim /usr/local/etc/zabbix_server.conf

                                38 LogFile=/tmp/zabbix_server.log
                                85 DBHost=localhost
                                95 DBName=zabbix
                                111 DBUser=zabbix
                                119 DBPassword=zabbix

                                由于源码安装未指定用户

                                useradd zabbix
                                zabbix_server
                                ss -antulp | grep 10051

                            安装zabbix

                                被监控主机

                                      217  useradd -s /sbin/nologin zabbix
                                      218  yum -y install gcc pcre-devel

                                      220  yum -y install gcc pcre-devel
                                      221  ls
                                      222  tar -xf  zabbix-3.4.4.tar.gz
                                      223  cd zabbix-3.4.4/
                                      226  ./configure --enable-agent
                                      227  make && make install

                                      vim /usr/local/etc/zabbix_agentd.conf
                                          134 ServerActive=192.168.2.5:10051
                                          93  Server=127.0.0.1,192.168.2.5
                                          30  LogFile=/tmp/zabbix_agentd.log
                                      zabbix_agentd //启动agent服务
                                      ss -antulp |grep 10050

            自定义监控
                配置客户端

                    启动自定义监控
                        vim /usr/local/etc/zabbix_agentd.conf
                            264 Include=/usr/local/etc/zabbix_agentd.conf.d/
                             280 UnsafeUserParameters=1

                    定义监控命令
                         vim /usr/local/etc/zabbix_agentd.conf.d/user.number
                            UserParameter=user.number,wc -l /etc/passwd | awk ' {print $1} '
                    重启服务
                         killall -9 zabbix_agentd
                         zabbix_agentd
                    本机测试
                        zabbix_get -s 127.0.0.1 -p 10050 -k user.number

                配置监控服务器
                    测试客户端定义监控
                        zabbix_get -s 192.168.2.100 -p 10050 -k user.number



       Zabbix报警机制
            触发器

                触发器表达式

                    常用的表达式
                        sum(600) 600s内所有值的总和
                        sum(#)最后5个值的总和
                    {web1:system.cpu.load[all,avg1].last(0)}>5
                    web1主机最新的cpu平均负载大于5,触发器状态为问题状态
                配置邮件服务器(在监控主机本机运行邮件服务器)
                    # yum -y  install postfix
                    ]# rpm -q postfix
                    ]# systemctl  start postfix
                    ]# netstat -utnlp  | grep  :25

                    //////////确认可以使用hostname访问本机///////////////

                    ]# vim /etc/hosts
                    127.0.0.1       zabbix-server  localhost localhost.localdomain localhost4 localhost4.localdomain4
                    :wq


                    ]# yum -y  install mailx
                    [root@zabbix-server ~]# which  mailx
                    /usr/bin/mailx
                    [root@zabbix-server ~]# mail -s "xxx"  zabbix  < /etc/yum.repos.d/local.repo
                    [root@zabbix-server ~]#
                    [root@zabbix-server ~]# su - zabbix
                    [zabbix@zabbix-server ~]$
                    [zabbix@zabbix-server ~]$ mail
                    Heirloom Mail version 12.5 7/5/10.  Type ? for help.
                    "/var/spool/mail/zabbix": 1 message 1 new
                    >N  1 root                  Fri Jun 28 09:48  22/734   "xxx"
                    & exit
                    [zabbix@zabbix-server ~]$ exit
                    logout

                指定邮件服务器
                    创建Media （指定收件人）
                    创建Action   名aone
                    验证配置： 监控到主机100的用户数量大于28个时,zabbix@localhost邮箱是否收到邮件。



       Zabbix进阶操作

            自动发现
                创建自动发现

                创建动作

            主被动监控
               主动监控

               被动监控(默认)

               配置主动监控
                    配置客户端  192.168.2.201

                        安装zabbix
                            useradd zabbix
                        修改配置文件
                            vim /usr/local/etc/zabbix_agentd.conf
                            93 #Server=127.0.0.1  //
                            118 StartAgents=0   //主动链接服务器,不需要端口
                            134 ServerActive=192.168.2.5  //监控主机
                            145 Hostname=Zabbix client web2 //主动监控模式,依靠hostname区分主机
                            183 RefreshActiveChecks=120     //自动刷新时间
                        启动服务
                            zabbix_agentd
                            ps  aux | grep agentd   //只有服务没有端口
                            ss -antulp | grep 10050

                    配置监控主机
                        登录2.5管理
                        克隆模板
                          全克隆
                        修改监控项模式


            监控案例

                监控nginx

                    2.100安装lnmp
                        在客户端创建监控命令 nginx.status[*]

                    配置监控服务器

                        登陆监控服务的管理页面做如下配置:
                        1 创建监控模板 	Atmp2
                        2 创建应用集      mon-nginx
                        3 创建监控项 并关联到对应的监控命令
                        now_link_num  	  nginx.status[Active]
                        now_link_req	  nginx.status[accepts]
                        now_waiting_num   nginx.status[Waiting]

                        4 添加监控主机 并调用监控模板
                        5 查看监控数据




